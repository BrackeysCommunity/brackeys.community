services:
  vercel-env-fetcher:
    image: docker:cli
    working_dir: /app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - repo_data:/app
    environment:
      - VERCEL_TOKEN=${VERCEL_TOKEN}
      - VERCEL_ORG_ID=${VERCEL_ORG_ID:-}
      - VERCEL_PROJECT_ID=${VERCEL_PROJECT_ID:-}
      - VERCEL_ENVIRONMENT=${VERCEL_ENVIRONMENT:-development}
      - GIT_REPO=${GIT_REPO:-https://github.com/BrackeysCommunity/brackeys.community.git}
      - GIT_BRANCH=${GIT_BRANCH:-main}
    command: >
      sh -c "
        if [ -z \"$$VERCEL_TOKEN\" ]; then
          echo '‚ùå VERCEL_TOKEN not set!';
          echo 'Get your token from: https://vercel.com/account/tokens';
          echo 'Then run: export VERCEL_TOKEN=your_token_here';
          exit 1;
        fi &&
        echo 'üì¶ Installing dependencies...' &&
        apk add --no-cache git curl bash unzip libstdc++ libgcc nodejs npm &&
        echo 'üîÑ Setting up repository...' &&
        if [ -d /app/repo/.git ]; then
          echo 'Repository exists, pulling latest changes...' &&
          cd /app/repo &&
          git fetch origin $$GIT_BRANCH &&
          git reset --hard origin/$$GIT_BRANCH &&
          git clean -fdx;
        else
          echo 'Cloning repository...' &&
          rm -rf /app/repo &&
          git clone --depth 1 --branch $$GIT_BRANCH $$GIT_REPO /app/repo &&
          cd /app/repo;
        fi &&
        echo 'üîê Installing Vercel CLI...' &&
        npm install -g vercel &&
        echo 'üîê Pulling environment variables from Vercel...' &&
        vercel env pull --environment=$$VERCEL_ENVIRONMENT --yes --token=$$VERCEL_TOKEN &&
        if [ ! -f .env.local ]; then
          echo '‚ùå Failed to fetch environment variables';
          exit 1;
        fi &&
        echo '‚úì Environment variables synced from Vercel!' &&
        echo 'üê≥ Loading environment variables...' &&
        set -a && . /app/repo/.env.local && set +a &&
        echo 'üê≥ Starting application services...' &&
        docker compose -f docker-compose.services.yml up -d &&
        echo '‚úÖ All services started successfully!'
      "
    restart: 'no'
    networks:
      - brackeys

volumes:
  repo_data:

networks:
  brackeys:
    name: brackeys
    driver: bridge
