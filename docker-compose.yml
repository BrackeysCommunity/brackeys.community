services:
  vercel-env-fetcher:
    image: docker:cli
    working_dir: /workspace
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - VERCEL_TOKEN=${VERCEL_TOKEN}
      - VERCEL_ORG_ID=${VERCEL_ORG_ID:-}
      - VERCEL_PROJECT_ID=${VERCEL_PROJECT_ID:-}
      - VERCEL_ENVIRONMENT=${VERCEL_ENVIRONMENT:-development}
      - COMPOSE_PROJECT_DIR=${PWD}
    command: >
      sh -c "
        if [ -z \"$$VERCEL_TOKEN\" ]; then
          echo '‚ùå VERCEL_TOKEN not set!';
          echo 'Get your token from: https://vercel.com/account/tokens';
          echo 'Then run: export VERCEL_TOKEN=your_token_here';
          exit 1;
        fi &&
        echo 'üîê Installing Vercel CLI...' &&
        apk add --no-cache curl bash unzip libstdc++ libgcc nodejs npm &&
        npm install -g vercel &&
        echo 'üîê Pulling environment variables from Vercel...' &&
        vercel env pull --environment=$$VERCEL_ENVIRONMENT --yes --token=$$VERCEL_TOKEN &&
        if [ ! -f .env.local ]; then
          echo '‚ùå Failed to fetch environment variables';
          exit 1;
        fi &&
        echo '‚úì Environment variables synced from Vercel!' &&
        echo 'üê≥ Starting application services...' &&
        cd /workspace &&
        export COMPOSE_PROJECT_DIR=$${COMPOSE_PROJECT_DIR:-/workspace} &&
        docker compose --env-file .env.local -f docker-compose.services.yml up -d &&
        echo '‚úÖ All services started successfully!'
      "
    restart: 'no'
    networks:
      - brackeys

networks:
  brackeys:
    name: brackeys
    driver: bridge
