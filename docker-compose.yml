services:
  vercel-env-fetcher:
    image: docker:cli
    working_dir: /app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - repo_data:/app
    environment:
      - VERCEL_TOKEN=${VERCEL_TOKEN}
      - VERCEL_ORG_ID=${VERCEL_ORG_ID:-}
      - VERCEL_PROJECT_ID=${VERCEL_PROJECT_ID:-}
      - VERCEL_ENVIRONMENT=${VERCEL_ENVIRONMENT:-development}
      - GIT_REPO=${GIT_REPO:-https://github.com/BrackeysCommunity/brackeys.community.git}
      - GIT_BRANCH=${GIT_BRANCH:-main}
    command: >
      sh -c "
        if [ -z \"$$VERCEL_TOKEN\" ]; then
          echo 'âŒ VERCEL_TOKEN not set!';
          echo 'Get your token from: https://vercel.com/account/tokens';
          echo 'Then run: export VERCEL_TOKEN=your_token_here';
          exit 1;
        fi &&
        echo 'ğŸ“¦ Installing dependencies...' &&
        apk add --no-cache git curl bash unzip libstdc++ libgcc nodejs npm &&
        echo 'ğŸ”„ Setting up repository...' &&
        if [ -d /app/.git ]; then
          echo 'Repository exists, pulling latest changes...' &&
          cd /app &&
          git fetch origin $$GIT_BRANCH &&
          git reset --hard origin/$$GIT_BRANCH &&
          git clean -fdx;
        else
          echo 'Cloning repository...' &&
          rm -rf /app/* /app/.* 2>/dev/null || true &&
          git clone --depth 1 --branch $$GIT_BRANCH $$GIT_REPO /app/temp &&
          mv /app/temp/.git /app/ &&
          mv /app/temp/* /app/temp/.* /app/ 2>/dev/null || true &&
          rm -rf /app/temp &&
          cd /app;
        fi &&
        echo 'ğŸ” Installing Vercel CLI...' &&
        npm install -g vercel &&
        echo 'ğŸ” Pulling environment variables from Vercel...' &&
        vercel env pull --environment=$$VERCEL_ENVIRONMENT --yes --token=$$VERCEL_TOKEN &&
        if [ ! -f .env.local ]; then
          echo 'âŒ Failed to fetch environment variables';
          exit 1;
        fi &&
        echo 'âœ“ Environment variables synced from Vercel!' &&
        echo 'ğŸ³ Loading environment variables...' &&
        set -a && . /app/.env.local && set +a &&
        echo 'ğŸ³ Starting application services...' &&
        docker compose -f docker-compose.services.yml up -d &&
        echo 'âœ… All services started successfully!'
      "
    restart: 'no'
    networks:
      - brackeys

volumes:
  repo_data:

networks:
  brackeys:
    name: brackeys
    driver: bridge
